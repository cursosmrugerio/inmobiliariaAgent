import{h as z,r as l,j as e,v as L,k,B as O,P as M,T as G}from"./index-83d1839a.js";import{u as _,o as H,n as J,D as K,a as Q,b as U,C as u,F as X,p as Y,c as Z,d as V,m as ee,e as f,q as ae,f as se,G as q,g as te,h as oe,i as re,I as ie,j as le,k as ne,l as ce,S as de}from"./index.esm-9cf95b61.js";import{G as m,L as me}from"./LoadingSpinner-fa054fe4.js";import"./agentService-0a27ba7e.js";import{p as P}from"./personaService-87614c8f.js";import{T as p}from"./TextField-66d2e082.js";import{C as ue}from"./ToggleButton-e374f116.js";var h=(a=>(a.FISICA="FISICA",a.MORAL="MORAL",a))(h||{});const pe=a=>V({tipoPersona:ee().oneOf(Object.values(h),a("personas.validation.tipoRequired")).required(a("personas.validation.tipoRequired")),nombre:f().when("tipoPersona",{is:t=>t===h.FISICA,then:t=>t.required(a("personas.validation.nombreRequired")),otherwise:t=>t.optional()}),apellidos:f().when("tipoPersona",{is:t=>t===h.FISICA,then:t=>t.required(a("personas.validation.apellidosRequired")),otherwise:t=>t.optional()}),razonSocial:f().optional(),rfc:f().required(a("personas.validation.rfcRequired")),curp:f().optional(),email:f().email(a("personas.validation.emailInvalid")).required(a("personas.validation.emailRequired")),telefono:f().required(a("personas.validation.telefonoRequired")),fechaAlta:f().required(),activo:ae()}),W=a=>a===h.MORAL,fe=({open:a,persona:t,onClose:w,onSuccess:A})=>{const{t:i}=z(),b=!!t,I=l.useMemo(()=>pe(i),[i]),{control:d,handleSubmit:v,reset:S,formState:{errors:n,isSubmitting:y}}=_({resolver:H(I),defaultValues:{tipoPersona:h.FISICA,nombre:"",apellidos:"",razonSocial:"",rfc:"",curp:"",email:"",telefono:"",fechaAlta:new Date().toISOString(),activo:!0}}),g=J({control:d,name:"tipoPersona"});l.useEffect(()=>{S(t?{tipoPersona:t.tipoPersona,nombre:t.nombre??"",apellidos:t.apellidos??"",razonSocial:t.razonSocial??"",rfc:t.rfc,curp:t.curp??"",email:t.email,telefono:t.telefono,fechaAlta:t.fechaAlta,activo:t.activo}:{tipoPersona:h.FISICA,nombre:"",apellidos:"",razonSocial:"",rfc:"",curp:"",email:"",telefono:"",fechaAlta:new Date().toISOString(),activo:!0})},[t,S]);const C=async s=>{const o=W(s.tipoPersona),c={tipoPersona:s.tipoPersona,nombre:o?void 0:s.nombre.trim()||void 0,apellidos:o?void 0:s.apellidos.trim()||void 0,razonSocial:o&&s.razonSocial.trim()||void 0,rfc:s.rfc.trim(),curp:s.curp.trim()||void 0,email:s.email.trim(),telefono:s.telefono.trim(),fechaAlta:s.fechaAlta,activo:s.activo};try{b&&t?await P.update(t.id,{...c,id:t.id}):await P.create(c),A()}catch(x){console.error("Error saving persona",x)}};return e.jsx(K,{open:a,onClose:w,maxWidth:"md",fullWidth:!0,children:e.jsxs("form",{onSubmit:v(C),children:[e.jsx(Q,{children:i(b?"personas.edit":"personas.create")}),e.jsx(U,{children:e.jsxs(m,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(m,{item:!0,xs:12,md:6,children:e.jsx(u,{name:"tipoPersona",control:d,render:({field:s})=>{var o;return e.jsx(p,{...s,select:!0,fullWidth:!0,label:i("personas.fields.tipoPersona"),error:!!n.tipoPersona,helperText:(o=n.tipoPersona)==null?void 0:o.message,children:Object.values(h).map(c=>e.jsx(L,{value:c,children:i(`personas.tipos.${c}`)},c))})}})}),e.jsx(m,{item:!0,xs:12,md:6,children:e.jsx(u,{name:"rfc",control:d,render:({field:s})=>{var o;return e.jsx(p,{...s,fullWidth:!0,label:i("personas.fields.rfc"),error:!!n.rfc,helperText:(o=n.rfc)==null?void 0:o.message})}})}),W(g)?e.jsx(m,{item:!0,xs:12,children:e.jsx(u,{name:"razonSocial",control:d,render:({field:s})=>e.jsx(p,{...s,fullWidth:!0,label:i("personas.fields.razonSocial")})})}):e.jsxs(e.Fragment,{children:[e.jsx(m,{item:!0,xs:12,md:6,children:e.jsx(u,{name:"nombre",control:d,render:({field:s})=>{var o;return e.jsx(p,{...s,fullWidth:!0,label:i("personas.fields.nombre"),error:!!n.nombre,helperText:(o=n.nombre)==null?void 0:o.message})}})}),e.jsx(m,{item:!0,xs:12,md:6,children:e.jsx(u,{name:"apellidos",control:d,render:({field:s})=>{var o;return e.jsx(p,{...s,fullWidth:!0,label:i("personas.fields.apellidos"),error:!!n.apellidos,helperText:(o=n.apellidos)==null?void 0:o.message})}})})]}),e.jsx(m,{item:!0,xs:12,md:6,children:e.jsx(u,{name:"curp",control:d,render:({field:s})=>e.jsx(p,{...s,fullWidth:!0,label:i("personas.fields.curp")})})}),e.jsx(m,{item:!0,xs:12,md:6,children:e.jsx(u,{name:"email",control:d,render:({field:s})=>{var o;return e.jsx(p,{...s,fullWidth:!0,type:"email",label:i("personas.fields.email"),error:!!n.email,helperText:(o=n.email)==null?void 0:o.message})}})}),e.jsx(m,{item:!0,xs:12,md:6,children:e.jsx(u,{name:"telefono",control:d,render:({field:s})=>{var o;return e.jsx(p,{...s,fullWidth:!0,label:i("personas.fields.telefono"),error:!!n.telefono,helperText:(o=n.telefono)==null?void 0:o.message})}})}),e.jsx(m,{item:!0,xs:12,md:6,children:e.jsx(u,{name:"fechaAlta",control:d,render:({field:s})=>{var o;return e.jsx(p,{...s,fullWidth:!0,type:"datetime-local",label:i("personas.fields.fechaAlta"),value:s.value?s.value.slice(0,16):"",onChange:c=>{const x=c.target.value;s.onChange(x?new Date(x).toISOString():"")},InputLabelProps:{shrink:!0},error:!!n.fechaAlta,helperText:(o=n.fechaAlta)==null?void 0:o.message})}})}),e.jsx(m,{item:!0,xs:12,children:e.jsx(u,{name:"activo",control:d,render:({field:s})=>e.jsx(X,{control:e.jsx(Y,{...s,checked:s.value}),label:i("personas.fields.activo")})})})]})}),e.jsxs(Z,{children:[e.jsx(k,{onClick:w,disabled:y,children:i("common.cancel")}),e.jsx(k,{type:"submit",variant:"contained",disabled:y,children:i("common.save")})]})]})})},he=a=>a.nombre||a.apellidos?`${a.nombre??""} ${a.apellidos??""}`.trim():a.razonSocial?a.razonSocial:"",xe=a=>{if(!a)return"-";const t=new Date(a);return Number.isNaN(t.getTime())?"-":new Intl.DateTimeFormat(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}).format(t)},ye=()=>{const{t:a}=z(),[t,w]=l.useState([]),[A,i]=l.useState(!0),[b,I]=l.useState(""),[d,v]=l.useState(!1),[S,n]=l.useState(null),[y,g]=l.useState(!1),[C,s]=l.useState(null),[o,c]=l.useState({open:!1,message:"",severity:"success"}),x=se(b,300),j=l.useCallback(async()=>{try{i(!0);const r=await P.getAll();w(r)}catch(r){console.error("Error loading personas",r),c({open:!0,message:a("common.saveError"),severity:"error"})}finally{i(!1)}},[a]);l.useEffect(()=>{j()},[j]);const N=l.useCallback(()=>{n(null),v(!0)},[]),T=l.useCallback(r=>{n(r),v(!0)},[]),F=l.useCallback(r=>{s(r),g(!0)},[]),R=l.useCallback(async()=>{if(C!==null)try{await P.delete(C),c({open:!0,message:a("common.deleteSuccess"),severity:"success"}),await j()}catch(r){console.error("Error deleting persona",r),c({open:!0,message:a("common.deleteError"),severity:"error"})}finally{g(!1),s(null)}},[C,j,a]),B=l.useCallback(async()=>{v(!1),await j(),c({open:!0,message:a("common.saveSuccess"),severity:"success"})},[j,a]),E=l.useMemo(()=>[{field:"id",headerName:"ID",width:80},{field:"tipoPersona",headerName:a("personas.fields.tipoPersona"),width:160,valueFormatter:r=>a(`personas.tipos.${r}`)},{field:"nombreCompleto",headerName:a("personas.fields.nombre"),flex:1,minWidth:220,valueGetter:(r,D)=>he(D)},{field:"rfc",headerName:a("personas.fields.rfc"),width:160},{field:"email",headerName:a("personas.fields.email"),width:220},{field:"telefono",headerName:a("personas.fields.telefono"),width:160},{field:"fechaAlta",headerName:a("personas.fields.fechaAlta"),width:160,valueFormatter:({value:r})=>xe(r)},{field:"activo",headerName:a("personas.fields.activo"),width:140,renderCell:r=>e.jsx(ue,{label:r.value?a("personas.status.active"):a("personas.status.inactive"),color:r.value?"success":"default",size:"small",variant:r.value?"filled":"outlined"})},{field:"actions",type:"actions",headerName:a("common.actions"),width:120,getActions:r=>[e.jsx(q,{icon:e.jsx(te,{}),label:a("common.edit"),onClick:()=>T(r.row),showInMenu:!1},"edit"),e.jsx(q,{icon:e.jsx(oe,{}),label:a("common.delete"),onClick:()=>F(r.row.id),showInMenu:!1},"delete")]}],[F,T,a]),$=l.useMemo(()=>t.filter(r=>Object.values(r).some(D=>String(D??"").toLowerCase().includes(x.trim().toLowerCase()))),[t,x]);return A?e.jsx(me,{fullScreen:!0}):e.jsxs(O,{sx:{p:3},children:[e.jsxs(M,{sx:{p:3},children:[e.jsxs(O,{sx:{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:2,mb:3},children:[e.jsx(G,{variant:"h4",children:a("personas.title")}),e.jsx(k,{variant:"contained",startIcon:e.jsx(re,{}),onClick:N,children:a("personas.create")})]}),e.jsx(p,{fullWidth:!0,placeholder:a("common.search"),value:b,onChange:r=>I(r.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(ie,{position:"start",children:e.jsx(le,{})})}}),e.jsx(ne,{rows:$,columns:E,initialState:{pagination:{paginationModel:{pageSize:10}}},pageSizeOptions:[5,10,25,50],disableRowSelectionOnClick:!0,autoHeight:!0})]}),e.jsx(fe,{open:d,persona:S,onClose:()=>v(!1),onSuccess:B}),e.jsx(ce,{open:y,title:a("common.delete"),onConfirm:R,onCancel:()=>g(!1)}),e.jsx(de,{open:o.open,message:o.message,severity:o.severity,onClose:()=>c(r=>({...r,open:!1}))})]})};export{fe as PersonaFormDialog,ye as PersonasPage};
