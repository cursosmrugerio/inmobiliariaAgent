import{h as k,r as n,j as e,v as L,k as y,B as N,P as M,T as G}from"./index-887becf6.js";import{u as _,o as H,n as J,D as K,a as Q,b as U,C as p,F as X,p as Y,c as Z,d as V,m as ee,e as h,q as ae,f as te,G as T,g as se,h as oe,i as re,I as ie,j as ne,k as le,l as ce,S as de}from"./index.esm-e4b82748.js";import{G as u,L as me}from"./LoadingSpinner-2e7a0bb1.js";import"./agentService-fe8b5178.js";import{p as w}from"./personaService-175f7282.js";import{T as f}from"./TextField-0b863460.js";import{C as ue}from"./ToggleButton-32112b83.js";var m=(a=>(a.ARRENDADOR="ARRENDADOR",a.ARRENDATARIO="ARRENDATARIO",a.FIADOR="FIADOR",a.OTRO="OTRO",a))(m||{});const pe=a=>V({tipoPersona:ee().oneOf(Object.values(m),a("personas.validation.tipoRequired")).required(a("personas.validation.tipoRequired")),nombre:h().when("tipoPersona",{is:t=>t===m.ARRENDADOR||t===m.ARRENDATARIO||t===m.FIADOR,then:t=>t.required(a("personas.validation.nombreRequired")),otherwise:t=>t.optional()}),apellidos:h().when("tipoPersona",{is:t=>t===m.ARRENDADOR||t===m.ARRENDATARIO||t===m.FIADOR,then:t=>t.required(a("personas.validation.apellidosRequired")),otherwise:t=>t.optional()}),razonSocial:h().optional(),rfc:h().required(a("personas.validation.rfcRequired")),curp:h().optional(),email:h().email(a("personas.validation.emailInvalid")).required(a("personas.validation.emailRequired")),telefono:h().required(a("personas.validation.telefonoRequired")),fechaAlta:h().required(),activo:ae()}),E=a=>a===m.OTRO,fe=({open:a,persona:t,onClose:R,onSuccess:C})=>{const{t:i}=k(),b=!!t,O=n.useMemo(()=>pe(i),[i]),{control:d,handleSubmit:j,reset:g,formState:{errors:l,isSubmitting:D}}=_({resolver:H(O),defaultValues:{tipoPersona:m.ARRENDADOR,nombre:"",apellidos:"",razonSocial:"",rfc:"",curp:"",email:"",telefono:"",fechaAlta:new Date().toISOString(),activo:!0}}),S=J({control:d,name:"tipoPersona"});n.useEffect(()=>{g(t?{tipoPersona:t.tipoPersona,nombre:t.nombre??"",apellidos:t.apellidos??"",razonSocial:t.razonSocial??"",rfc:t.rfc,curp:t.curp??"",email:t.email,telefono:t.telefono,fechaAlta:t.fechaAlta,activo:t.activo}:{tipoPersona:m.ARRENDADOR,nombre:"",apellidos:"",razonSocial:"",rfc:"",curp:"",email:"",telefono:"",fechaAlta:new Date().toISOString(),activo:!0})},[t,g]);const A=async s=>{const o=E(s.tipoPersona),c={tipoPersona:s.tipoPersona,nombre:o?void 0:s.nombre.trim()||void 0,apellidos:o?void 0:s.apellidos.trim()||void 0,razonSocial:o&&s.razonSocial.trim()||void 0,rfc:s.rfc.trim(),curp:s.curp.trim()||void 0,email:s.email.trim(),telefono:s.telefono.trim(),fechaAlta:s.fechaAlta,activo:s.activo};try{b&&t?await w.update(t.id,{...c,id:t.id}):await w.create(c),C()}catch(x){console.error("Error saving persona",x)}};return e.jsx(K,{open:a,onClose:R,maxWidth:"md",fullWidth:!0,children:e.jsxs("form",{onSubmit:j(A),children:[e.jsx(Q,{children:i(b?"personas.edit":"personas.create")}),e.jsx(U,{children:e.jsxs(u,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(u,{item:!0,xs:12,md:6,children:e.jsx(p,{name:"tipoPersona",control:d,render:({field:s})=>{var o;return e.jsx(f,{...s,select:!0,fullWidth:!0,label:i("personas.fields.tipoPersona"),error:!!l.tipoPersona,helperText:(o=l.tipoPersona)==null?void 0:o.message,children:Object.values(m).map(c=>e.jsx(L,{value:c,children:i(`personas.tipos.${c}`)},c))})}})}),e.jsx(u,{item:!0,xs:12,md:6,children:e.jsx(p,{name:"rfc",control:d,render:({field:s})=>{var o;return e.jsx(f,{...s,fullWidth:!0,label:i("personas.fields.rfc"),error:!!l.rfc,helperText:(o=l.rfc)==null?void 0:o.message})}})}),E(S)?e.jsx(u,{item:!0,xs:12,children:e.jsx(p,{name:"razonSocial",control:d,render:({field:s})=>e.jsx(f,{...s,fullWidth:!0,label:i("personas.fields.razonSocial")})})}):e.jsxs(e.Fragment,{children:[e.jsx(u,{item:!0,xs:12,md:6,children:e.jsx(p,{name:"nombre",control:d,render:({field:s})=>{var o;return e.jsx(f,{...s,fullWidth:!0,label:i("personas.fields.nombre"),error:!!l.nombre,helperText:(o=l.nombre)==null?void 0:o.message})}})}),e.jsx(u,{item:!0,xs:12,md:6,children:e.jsx(p,{name:"apellidos",control:d,render:({field:s})=>{var o;return e.jsx(f,{...s,fullWidth:!0,label:i("personas.fields.apellidos"),error:!!l.apellidos,helperText:(o=l.apellidos)==null?void 0:o.message})}})})]}),e.jsx(u,{item:!0,xs:12,md:6,children:e.jsx(p,{name:"curp",control:d,render:({field:s})=>e.jsx(f,{...s,fullWidth:!0,label:i("personas.fields.curp")})})}),e.jsx(u,{item:!0,xs:12,md:6,children:e.jsx(p,{name:"email",control:d,render:({field:s})=>{var o;return e.jsx(f,{...s,fullWidth:!0,type:"email",label:i("personas.fields.email"),error:!!l.email,helperText:(o=l.email)==null?void 0:o.message})}})}),e.jsx(u,{item:!0,xs:12,md:6,children:e.jsx(p,{name:"telefono",control:d,render:({field:s})=>{var o;return e.jsx(f,{...s,fullWidth:!0,label:i("personas.fields.telefono"),error:!!l.telefono,helperText:(o=l.telefono)==null?void 0:o.message})}})}),e.jsx(u,{item:!0,xs:12,md:6,children:e.jsx(p,{name:"fechaAlta",control:d,render:({field:s})=>{var o;return e.jsx(f,{...s,fullWidth:!0,type:"datetime-local",label:i("personas.fields.fechaAlta"),value:s.value?s.value.slice(0,16):"",onChange:c=>{const x=c.target.value;s.onChange(x?new Date(x).toISOString():"")},InputLabelProps:{shrink:!0},error:!!l.fechaAlta,helperText:(o=l.fechaAlta)==null?void 0:o.message})}})}),e.jsx(u,{item:!0,xs:12,children:e.jsx(p,{name:"activo",control:d,render:({field:s})=>e.jsx(X,{control:e.jsx(Y,{...s,checked:s.value}),label:i("personas.fields.activo")})})})]})}),e.jsxs(Z,{children:[e.jsx(y,{onClick:R,disabled:D,children:i("common.cancel")}),e.jsx(y,{type:"submit",variant:"contained",disabled:D,children:i("common.save")})]})]})})},he=a=>a.nombre||a.apellidos?`${a.nombre??""} ${a.apellidos??""}`.trim():a.razonSocial?a.razonSocial:"",xe=a=>{if(!a)return"-";const t=new Date(a);return Number.isNaN(t.getTime())?"-":new Intl.DateTimeFormat(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}).format(t)},De=()=>{const{t:a}=k(),[t,R]=n.useState([]),[C,i]=n.useState(!0),[b,O]=n.useState(""),[d,j]=n.useState(!1),[g,l]=n.useState(null),[D,S]=n.useState(!1),[A,s]=n.useState(null),[o,c]=n.useState({open:!1,message:"",severity:"success"}),x=te(b,300),v=n.useCallback(async()=>{try{i(!0);const r=await w.getAll();R(r)}catch(r){console.error("Error loading personas",r),c({open:!0,message:a("common.saveError"),severity:"error"})}finally{i(!1)}},[a]);n.useEffect(()=>{v()},[v]);const F=n.useCallback(()=>{l(null),j(!0)},[]),P=n.useCallback(r=>{l(r),j(!0)},[]),I=n.useCallback(r=>{s(r),S(!0)},[]),q=n.useCallback(async()=>{if(A!==null)try{await w.delete(A),c({open:!0,message:a("common.deleteSuccess"),severity:"success"}),await v()}catch(r){console.error("Error deleting persona",r),c({open:!0,message:a("common.deleteError"),severity:"error"})}finally{S(!1),s(null)}},[A,v,a]),W=n.useCallback(async()=>{j(!1),await v(),c({open:!0,message:a("common.saveSuccess"),severity:"success"})},[v,a]),z=n.useMemo(()=>[{field:"id",headerName:"ID",width:80},{field:"tipoPersona",headerName:a("personas.fields.tipoPersona"),width:160,valueFormatter:({value:r})=>a(`personas.tipos.${r}`)},{field:"nombreCompleto",headerName:a("personas.fields.nombre"),flex:1,minWidth:220,valueGetter:r=>he(r.row)},{field:"rfc",headerName:a("personas.fields.rfc"),width:160},{field:"email",headerName:a("personas.fields.email"),width:220},{field:"telefono",headerName:a("personas.fields.telefono"),width:160},{field:"fechaAlta",headerName:a("personas.fields.fechaAlta"),width:160,valueFormatter:({value:r})=>xe(r)},{field:"activo",headerName:a("personas.fields.activo"),width:140,renderCell:r=>e.jsx(ue,{label:r.value?a("personas.status.active"):a("personas.status.inactive"),color:r.value?"success":"default",size:"small",variant:r.value?"filled":"outlined"})},{field:"actions",type:"actions",headerName:a("common.actions"),width:120,getActions:r=>[e.jsx(T,{icon:e.jsx(se,{}),label:a("common.edit"),onClick:()=>P(r.row),showInMenu:!1},"edit"),e.jsx(T,{icon:e.jsx(oe,{}),label:a("common.delete"),onClick:()=>I(r.row.id),showInMenu:!1},"delete")]}],[I,P,a]),B=n.useMemo(()=>t.filter(r=>Object.values(r).some($=>String($??"").toLowerCase().includes(x.trim().toLowerCase()))),[t,x]);return C?e.jsx(me,{fullScreen:!0}):e.jsxs(N,{sx:{p:3},children:[e.jsxs(M,{sx:{p:3},children:[e.jsxs(N,{sx:{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:2,mb:3},children:[e.jsx(G,{variant:"h4",children:a("personas.title")}),e.jsx(y,{variant:"contained",startIcon:e.jsx(re,{}),onClick:F,children:a("personas.create")})]}),e.jsx(f,{fullWidth:!0,placeholder:a("common.search"),value:b,onChange:r=>O(r.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(ie,{position:"start",children:e.jsx(ne,{})})}}),e.jsx(le,{rows:B,columns:z,initialState:{pagination:{paginationModel:{pageSize:10}}},pageSizeOptions:[5,10,25,50],disableRowSelectionOnClick:!0,autoHeight:!0})]}),e.jsx(fe,{open:d,persona:g,onClose:()=>j(!1),onSuccess:W}),e.jsx(ce,{open:D,title:a("common.delete"),onConfirm:q,onCancel:()=>S(!1)}),e.jsx(de,{open:o.open,message:o.message,severity:o.severity,onClose:()=>c(r=>({...r,open:!1}))})]})};export{fe as PersonaFormDialog,De as PersonasPage};
