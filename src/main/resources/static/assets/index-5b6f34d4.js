import{v as D,h as F,r as i,j as a,w as M,k as P,B as T,P as G,T as _}from"./index-62307a83.js";import{u as H,o as J,n as K,D as Q,a as U,b as X,C as p,F as Y,p as Z,c as V,d as ee,m as ae,e as h,q as se,f as te,G as E,g as oe,h as re,L as ne,i as ie,I as le,j as ce,k as de,l as me,S as ue}from"./index.esm-880747b5.js";import{C as pe}from"./agentService-cbb174ed.js";import{G as u}from"./Grid-fa45856e.js";import{T as f}from"./TextField-1b0da952.js";const y={getAll:async()=>(await D.get("/personas")).data,getById:async e=>(await D.get(`/personas/${e}`)).data,create:async e=>(await D.post("/personas",e)).data,update:async(e,s)=>(await D.put(`/personas/${e}`,s)).data,delete:async e=>{await D.delete(`/personas/${e}`)}};var m=(e=>(e.ARRENDADOR="ARRENDADOR",e.ARRENDATARIO="ARRENDATARIO",e.FIADOR="FIADOR",e.OTRO="OTRO",e))(m||{});const fe=e=>ee({tipoPersona:ae().oneOf(Object.values(m),e("personas.validation.tipoRequired")).required(e("personas.validation.tipoRequired")),nombre:h().when("tipoPersona",{is:s=>s===m.ARRENDADOR||s===m.ARRENDATARIO||s===m.FIADOR,then:s=>s.required(e("personas.validation.nombreRequired")),otherwise:s=>s.optional()}),apellidos:h().when("tipoPersona",{is:s=>s===m.ARRENDADOR||s===m.ARRENDATARIO||s===m.FIADOR,then:s=>s.required(e("personas.validation.apellidosRequired")),otherwise:s=>s.optional()}),razonSocial:h().optional(),rfc:h().required(e("personas.validation.rfcRequired")),curp:h().optional(),email:h().email(e("personas.validation.emailInvalid")).required(e("personas.validation.emailRequired")),telefono:h().required(e("personas.validation.telefonoRequired")),fechaAlta:h().required(),activo:se()}),k=e=>e===m.OTRO,he=({open:e,persona:s,onClose:b,onSuccess:C})=>{const{t:n}=F(),g=!!s,O=i.useMemo(()=>fe(n),[n]),{control:d,handleSubmit:j,reset:S,formState:{errors:l,isSubmitting:w}}=H({resolver:J(O),defaultValues:{tipoPersona:m.ARRENDADOR,nombre:"",apellidos:"",razonSocial:"",rfc:"",curp:"",email:"",telefono:"",fechaAlta:new Date().toISOString(),activo:!0}}),A=K({control:d,name:"tipoPersona"});i.useEffect(()=>{S(s?{tipoPersona:s.tipoPersona,nombre:s.nombre??"",apellidos:s.apellidos??"",razonSocial:s.razonSocial??"",rfc:s.rfc,curp:s.curp??"",email:s.email,telefono:s.telefono,fechaAlta:s.fechaAlta,activo:s.activo}:{tipoPersona:m.ARRENDADOR,nombre:"",apellidos:"",razonSocial:"",rfc:"",curp:"",email:"",telefono:"",fechaAlta:new Date().toISOString(),activo:!0})},[s,S]);const R=async t=>{const o=k(t.tipoPersona),c={tipoPersona:t.tipoPersona,nombre:o?void 0:t.nombre.trim()||void 0,apellidos:o?void 0:t.apellidos.trim()||void 0,razonSocial:o&&t.razonSocial.trim()||void 0,rfc:t.rfc.trim(),curp:t.curp.trim()||void 0,email:t.email.trim(),telefono:t.telefono.trim(),fechaAlta:t.fechaAlta,activo:t.activo};try{g&&s?await y.update(s.id,{...c,id:s.id}):await y.create(c),C()}catch(x){console.error("Error saving persona",x)}};return a.jsx(Q,{open:e,onClose:b,maxWidth:"md",fullWidth:!0,children:a.jsxs("form",{onSubmit:j(R),children:[a.jsx(U,{children:n(g?"personas.edit":"personas.create")}),a.jsx(X,{children:a.jsxs(u,{container:!0,spacing:2,sx:{mt:1},children:[a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(p,{name:"tipoPersona",control:d,render:({field:t})=>{var o;return a.jsx(f,{...t,select:!0,fullWidth:!0,label:n("personas.fields.tipoPersona"),error:!!l.tipoPersona,helperText:(o=l.tipoPersona)==null?void 0:o.message,children:Object.values(m).map(c=>a.jsx(M,{value:c,children:n(`personas.tipos.${c}`)},c))})}})}),a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(p,{name:"rfc",control:d,render:({field:t})=>{var o;return a.jsx(f,{...t,fullWidth:!0,label:n("personas.fields.rfc"),error:!!l.rfc,helperText:(o=l.rfc)==null?void 0:o.message})}})}),k(A)?a.jsx(u,{item:!0,xs:12,children:a.jsx(p,{name:"razonSocial",control:d,render:({field:t})=>a.jsx(f,{...t,fullWidth:!0,label:n("personas.fields.razonSocial")})})}):a.jsxs(a.Fragment,{children:[a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(p,{name:"nombre",control:d,render:({field:t})=>{var o;return a.jsx(f,{...t,fullWidth:!0,label:n("personas.fields.nombre"),error:!!l.nombre,helperText:(o=l.nombre)==null?void 0:o.message})}})}),a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(p,{name:"apellidos",control:d,render:({field:t})=>{var o;return a.jsx(f,{...t,fullWidth:!0,label:n("personas.fields.apellidos"),error:!!l.apellidos,helperText:(o=l.apellidos)==null?void 0:o.message})}})})]}),a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(p,{name:"curp",control:d,render:({field:t})=>a.jsx(f,{...t,fullWidth:!0,label:n("personas.fields.curp")})})}),a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(p,{name:"email",control:d,render:({field:t})=>{var o;return a.jsx(f,{...t,fullWidth:!0,type:"email",label:n("personas.fields.email"),error:!!l.email,helperText:(o=l.email)==null?void 0:o.message})}})}),a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(p,{name:"telefono",control:d,render:({field:t})=>{var o;return a.jsx(f,{...t,fullWidth:!0,label:n("personas.fields.telefono"),error:!!l.telefono,helperText:(o=l.telefono)==null?void 0:o.message})}})}),a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(p,{name:"fechaAlta",control:d,render:({field:t})=>{var o;return a.jsx(f,{...t,fullWidth:!0,type:"datetime-local",label:n("personas.fields.fechaAlta"),value:t.value?t.value.slice(0,16):"",onChange:c=>{const x=c.target.value;t.onChange(x?new Date(x).toISOString():"")},InputLabelProps:{shrink:!0},error:!!l.fechaAlta,helperText:(o=l.fechaAlta)==null?void 0:o.message})}})}),a.jsx(u,{item:!0,xs:12,children:a.jsx(p,{name:"activo",control:d,render:({field:t})=>a.jsx(Y,{control:a.jsx(Z,{...t,checked:t.value}),label:n("personas.fields.activo")})})})]})}),a.jsxs(V,{children:[a.jsx(P,{onClick:b,disabled:w,children:n("common.cancel")}),a.jsx(P,{type:"submit",variant:"contained",disabled:w,children:n("common.save")})]})]})})},xe=e=>e.nombre||e.apellidos?`${e.nombre??""} ${e.apellidos??""}`.trim():e.razonSocial?e.razonSocial:"",je=e=>{if(!e)return"-";const s=new Date(e);return Number.isNaN(s.getTime())?"-":new Intl.DateTimeFormat(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}).format(s)},Re=()=>{const{t:e}=F(),[s,b]=i.useState([]),[C,n]=i.useState(!0),[g,O]=i.useState(""),[d,j]=i.useState(!1),[S,l]=i.useState(null),[w,A]=i.useState(!1),[R,t]=i.useState(null),[o,c]=i.useState({open:!1,message:"",severity:"success"}),x=te(g,300),v=i.useCallback(async()=>{try{n(!0);const r=await y.getAll();b(r)}catch(r){console.error("Error loading personas",r),c({open:!0,message:e("common.saveError"),severity:"error"})}finally{n(!1)}},[e]);i.useEffect(()=>{v()},[v]);const q=i.useCallback(()=>{l(null),j(!0)},[]),I=i.useCallback(r=>{l(r),j(!0)},[]),N=i.useCallback(r=>{t(r),A(!0)},[]),W=i.useCallback(async()=>{if(R!==null)try{await y.delete(R),c({open:!0,message:e("common.deleteSuccess"),severity:"success"}),await v()}catch(r){console.error("Error deleting persona",r),c({open:!0,message:e("common.deleteError"),severity:"error"})}finally{A(!1),t(null)}},[R,v,e]),z=i.useCallback(async()=>{j(!1),await v(),c({open:!0,message:e("common.saveSuccess"),severity:"success"})},[v,e]),$=i.useMemo(()=>[{field:"id",headerName:"ID",width:80},{field:"tipoPersona",headerName:e("personas.fields.tipoPersona"),width:160,valueFormatter:({value:r})=>e(`personas.tipos.${r}`)},{field:"nombreCompleto",headerName:e("personas.fields.nombre"),flex:1,minWidth:220,valueGetter:r=>xe(r.row)},{field:"rfc",headerName:e("personas.fields.rfc"),width:160},{field:"email",headerName:e("personas.fields.email"),width:220},{field:"telefono",headerName:e("personas.fields.telefono"),width:160},{field:"fechaAlta",headerName:e("personas.fields.fechaAlta"),width:160,valueFormatter:({value:r})=>je(r)},{field:"activo",headerName:e("personas.fields.activo"),width:140,renderCell:r=>a.jsx(pe,{label:r.value?e("personas.status.active"):e("personas.status.inactive"),color:r.value?"success":"default",size:"small",variant:r.value?"filled":"outlined"})},{field:"actions",type:"actions",headerName:e("common.actions"),width:120,getActions:r=>[a.jsx(E,{icon:a.jsx(oe,{}),label:e("common.edit"),onClick:()=>I(r.row),showInMenu:!1},"edit"),a.jsx(E,{icon:a.jsx(re,{}),label:e("common.delete"),onClick:()=>N(r.row.id),showInMenu:!1},"delete")]}],[N,I,e]),B=i.useMemo(()=>s.filter(r=>Object.values(r).some(L=>String(L??"").toLowerCase().includes(x.trim().toLowerCase()))),[s,x]);return C?a.jsx(ne,{fullScreen:!0}):a.jsxs(T,{sx:{p:3},children:[a.jsxs(G,{sx:{p:3},children:[a.jsxs(T,{sx:{display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:2,mb:3},children:[a.jsx(_,{variant:"h4",children:e("personas.title")}),a.jsx(P,{variant:"contained",startIcon:a.jsx(ie,{}),onClick:q,children:e("personas.create")})]}),a.jsx(f,{fullWidth:!0,placeholder:e("common.search"),value:g,onChange:r=>O(r.target.value),sx:{mb:2},InputProps:{startAdornment:a.jsx(le,{position:"start",children:a.jsx(ce,{})})}}),a.jsx(de,{rows:B,columns:$,initialState:{pagination:{paginationModel:{pageSize:10}}},pageSizeOptions:[5,10,25,50],disableRowSelectionOnClick:!0,autoHeight:!0})]}),a.jsx(he,{open:d,persona:S,onClose:()=>j(!1),onSuccess:z}),a.jsx(me,{open:w,title:e("common.delete"),onConfirm:W,onCancel:()=>A(!1)}),a.jsx(ue,{open:o.open,message:o.message,severity:o.severity,onClose:()=>c(r=>({...r,open:!1}))})]})};export{he as PersonaFormDialog,Re as PersonasPage};
